<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Map Builder</title>
	<style>
		body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
		#app { display: flex; width: 100%; height: 100%; position: relative; }
		
		/* Left Sidebar */
		#sidebar {
			width: 300px;
			min-width: 300px;
			background: #2c3e50;
			color: white;
			display: flex;
			flex-direction: column;
			border-right: 2px solid #1a252f;
			z-index: 10;
		}
		#sidebar-header { padding: 15px; background: #1a252f; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
		
		/* Asset List Container */
		#asset-list {
			flex: 1;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			position: relative;
		}
		
		/* Empty State / Load Button Area */
		#asset-load-area {
			padding: 20px;
			text-align: center;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
		}
		
		/* Category Headers */
		.category-header {
			background: #34495e;
			padding: 10px 15px;
			cursor: pointer;
			font-weight: bold;
			border-bottom: 1px solid #2c3e50;
			border-top: 1px solid #46607a;
			display: flex;
			justify-content: space-between;
			align-items: center;
			user-select: none;
		}
		.category-header:hover { background: #3e5871; }
		.category-header::after { content: '▼'; font-size: 10px; transition: transform 0.2s; }
		.category-header.collapsed::after { transform: rotate(-90deg); }
		
		/* Asset Grid (per category) */
		.category-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 5px;
			padding: 10px;
			background: #233342;
		}
		.category-grid.hidden { display: none; }
		
		.asset-item {
			background: #34495e;
			border: 1px solid #46607a;
			cursor: pointer;
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 5px;
			border-radius: 4px;
			transition: background 0.2s;
		}
		.asset-item:hover { background: #3e5871; border-color: #2ecc71; }
		.asset-item:active { background: #27ae60; }
		
		.asset-thumb { width: 100%; height: 100px; object-fit: cover; background: #000; margin-bottom: 5px; pointer-events: none; }
		.asset-name { font-size: 10px; text-align: center; word-break: break-all; pointer-events: none; text-transform: capitalize; }
		
		/* Controls */
		#controls-container {
			background: #1a252f;
			display: flex;
			flex-direction: column;
			font-size: 14px;
			border-top: 2px solid #1a252f;
		}
		
		#controls-header {
			/* Reusing category-header styles but specific for controls */
			background: #2c3e50;
			padding: 10px 15px;
			cursor: pointer;
			font-weight: bold;
			display: flex;
			justify-content: space-between;
			align-items: center;
			user-select: none;
			border-top: 1px solid #46607a;
		}
		#controls-header:hover { background: #3e5871; }
		#controls-header::after { content: '▼'; font-size: 10px; transition: transform 0.2s; }
		#controls-header.collapsed::after { transform: rotate(-90deg); }
		
		#controls-content {
			padding: 15px;
			display: flex;
			flex-direction: column;
			gap: 10px;
			background: #1a252f;
		}
		#controls-content.hidden { display: none; }
		
		.control-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px; }
		.control-row { display: flex; gap: 5px; align-items: center; justify-content: space-between; }
		
		button { padding: 8px; cursor: pointer; background: #27ae60; border: none; color: white; border-radius: 4px; flex: 1; }
		button:hover { background: #2ecc71; }
		button.secondary { background: #e67e22; }
		button.danger { background: #c0392b; }
		button.info { background: #3498db; }
		button:disabled { background: #7f8c8d; cursor: not-allowed; }
		
		input[type="text"], input[type="number"] { padding: 5px; width: 100%; box-sizing: border-box; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; }
		input[type="checkbox"] { transform: scale(1.2); }
		input[type="color"] { width: 100%; height: 30px; border: none; padding: 0; cursor: pointer; }
		
		/* Floating Property Panel */
		#properties-panel {
			position: absolute;
			left: 300px; /* Aligned to the right of the sidebar */
			top: 10px;
			width: 250px;
			background: rgba(44, 62, 80, 0.95); /* Semi-transparent background */
			color: white;
			display: none; /* Hidden by default until object selected */
			flex-direction: column;
			border: 1px solid #1a252f;
			border-radius: 0 4px 4px 0;
			z-index: 20; /* Above canvas */
			padding: 10px;
			font-size: 13px;
			box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
			backdrop-filter: blur(4px);
		}
		
		.prop-group { margin-bottom: 15px; border-bottom: 1px solid #34495e; padding-bottom: 10px; }
		.prop-group label { display: block; margin-bottom: 5px; color: #bdc3c7; }
		.prop-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
		.prop-row span { width: 15px; text-align: center; color: #95a5a6; }
		
		/* Multi-select List Styles */
		#multi-select-container {
			max-height: 200px;
			overflow-y: auto;
			margin-bottom: 15px;
			border: 1px solid #34495e;
			background: #233342;
		}
		.multi-select-item {
			padding: 5px 8px;
			border-bottom: 1px solid #2c3e50;
			font-size: 12px;
		}
		.multi-select-item:last-child { border-bottom: none; }
		
		#renderCanvas { flex: 1; outline: none; touch-action: none; cursor: crosshair; }
		#fileInput { display: none; }
		
		/* Modal Styles */
		.modal-overlay {
			display: none;
			position: fixed;
			z-index: 100;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.5);
			align-items: center;
			justify-content: center;
		}
		
		.modal-content {
			background-color: #2c3e50;
			color: white;
			padding: 20px;
			border: 1px solid #1a252f;
			border-radius: 5px;
			width: 400px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.3);
		}
		
		.modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #34495e; padding-bottom: 10px; }
		.modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
		
		/* Context Menu */
		#context-menu {
			display: none;
			position: absolute;
			z-index: 1000;
			width: 150px;
			background: #2c3e50;
			border: 1px solid #1a252f;
			box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
			border-radius: 4px;
			overflow: hidden;
		}
		.ctx-item {
			padding: 8px 12px;
			color: white;
			font-size: 13px;
			cursor: pointer;
			border-bottom: 1px solid #34495e;
		}
		.ctx-item:hover { background: #34495e; }
		.ctx-item:last-child { border-bottom: none; }
		
		/* Loading Overlay */
		#loading-overlay {
			display: none;
			position: absolute;
			top: 0; left: 0; width: 100%; height: 100%;
			background: rgba(0,0,0,0.7);
			z-index: 2000;
			color: white;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			font-size: 20px;
		}
		.spinner {
			border: 4px solid rgba(255,255,255,0.3);
			border-top: 4px solid #2ecc71;
			border-radius: 50%;
			width: 40px;
			height: 40px;
			animation: spin 1s linear infinite;
			margin-bottom: 15px;
		}
		@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		
		#btnLoadAssets {
			max-height: 40px;
		}
	</style>
</head>
<body>
<div id="app">
	<!-- Loading Overlay -->
	<div id="loading-overlay">
		<div class="spinner"></div>
		<div id="loading-text">Generating Thumbnails...</div>
	</div>
	
	<!-- Left Sidebar -->
	<div id="sidebar">
		<div id="sidebar-header">
			Map Builder Assets
		</div>
		<div id="asset-list">
			<div id="asset-load-area">
				<p style="color: #bdc3c7; font-size: 13px; margin-bottom: 15px;">Assets not loaded.</p>
				<button id="btnLoadAssets" class="info">Load Assets</button>
			</div>
		</div>
		
		<!-- Collapsible Controls Container -->
		<div id="controls-container">
			<div id="controls-header">
				Map Controls
			</div>
			<div id="controls-content">
				<div class="control-row">
					<button id="btnUndo" class="secondary" disabled>Undo</button>
					<button id="btnRedo" class="secondary" disabled>Redo</button>
				</div>
				
				<div class="control-group">
					<label>Quick Snapping:</label>
					<div class="control-row">
						<label><input type="checkbox" id="chkSnapGrid"> Grid</label>
						<label><input type="checkbox" id="chkSnapObj"> Objects</label>
					</div>
				</div>
				
				<!-- Map Name input removed from here -->
				
				<!-- Added Reset Camera Button -->
				<button id="btnResetCam" class="secondary" style="margin-bottom: 5px;">Reset Camera</button>
				
				<button id="btnSettings" class="info">Global Settings</button>
				<button id="btnSave">Save Map (JSON)</button>
				<button id="btnSaveAs" class="secondary">Save As...</button>
				<button id="btnLoad" class="secondary">Load Map</button>
				<button id="btnAddLight">Add Point Light</button>
				<button id="btnClearScene" class="danger">Clear Scene</button>
				<input type="file" id="fileInput" accept=".json">
			</div>
			
			<!-- Auto Save Status -->
			<div id="auto-save-container" style="padding: 10px; border-top: 1px solid #34495e; font-size: 12px; color: #bdc3c7; text-align: center; background: #1a252f;">
				<span id="auto-save-text">Not saved yet.</span>
				<a href="#" id="btnSaveNow" style="color: #3498db; text-decoration: none; margin-left: 5px;">Save Now</a>
			</div>
		</div>
	</div>
	
	<!-- Canvas -->
	<canvas id="renderCanvas"></canvas>
	
	<!-- Floating Property Panel -->
	<div id="properties-panel">
		<!-- Lock Toggle (Global for single/multi) -->
		<div class="prop-group">
			<div class="prop-row" style="justify-content: flex-start;">
				<input type="checkbox" id="chkLock" style="width: auto; margin-right: 8px;">
				<label for="chkLock" style="margin: 0; cursor: pointer; color: white;">Lock Object(s)</label>
			</div>
		</div>
		
		<!-- Single Object View -->
		<div id="single-obj-props">
			<div class="prop-group">
				<label>Name</label>
				<input type="text" id="propName">
			</div>
			
			<div class="prop-group">
				<label>Position</label>
				<div class="prop-row"><span>X</span><input type="number" id="posX" step="0.1"></div>
				<div class="prop-row"><span>Y</span><input type="number" id="posY" step="0.1"></div>
				<div class="prop-row"><span>Z</span><input type="number" id="posZ" step="0.1"></div>
			</div>
			
			<div class="prop-group">
				<label>Rotation (Degrees)</label>
				<div class="prop-row"><span>X</span><input type="number" id="rotX" step="15"></div>
				<div class="prop-row"><span>Y</span><input type="number" id="rotY" step="15"></div>
				<div class="prop-row"><span>Z</span><input type="number" id="rotZ" step="15"></div>
			</div>
			
			<div class="prop-group">
				<label>Scale</label>
				<div class="prop-row"><span>X</span><input type="number" id="scaleX" step="0.1"></div>
				<div class="prop-row"><span>Y</span><input type="number" id="scaleY" step="0.1"></div>
				<div class="prop-row"><span>Z</span><input type="number" id="scaleZ" step="0.1"></div>
			</div>
		</div>
		
		<!-- Multi Object View -->
		<div id="multi-obj-props" style="display: none;">
			<div class="prop-group">
				<label>Alignment</label>
				<div class="control-row">
					<button id="btnAlignX" class="secondary">Align X</button>
					<button id="btnAlignY" class="secondary">Align Y</button>
					<button id="btnAlignZ" class="secondary">Align Z</button>
				</div>
			</div>
			<div class="prop-group">
				<label>Selected Objects</label>
				<div id="multi-select-container"></div>
			</div>
		</div>
		
		<!-- Buttons (Global for selection) -->
		<button id="btnDuplicate" class="info" style="margin-bottom: 5px;">Duplicate</button>
		<button id="btnDeleteObj" class="danger">Delete Object(s)</button>
	</div>
	
	<!-- Global Settings Modal -->
	<div id="settingsModal" class="modal-overlay">
		<div class="modal-content">
			<div class="modal-header">Global Settings</div>
			
			<div class="control-group">
				<label>New Object Y-Offset:</label>
				<input type="number" id="settingYOffset" step="0.1" value="0">
			</div>
			
			<div class="control-group">
				<label>Grid Cell Size:</label>
				<input type="number" id="settingGridSize" step="0.5" min="0.5" value="2.5">
			</div>
			
			<div class="control-group">
				<label>Grid Line Color:</label>
				<input type="color" id="settingGridColor" value="#555555">
			</div>
			
			<div class="control-group">
				<label>Canvas Background Color:</label>
				<input type="color" id="settingBgColor" value="#2c3e50">
			</div>
			
			<div class="control-group">
				<label>Default Snapping:</label>
				<div class="control-row">
					<label><input type="checkbox" id="settingSnapGrid"> Snap to Grid</label>
					<label><input type="checkbox" id="settingSnapObj"> Snap to Objects</label>
				</div>
			</div>
			
			<div class="control-group" style="margin-top: 10px; border-top: 1px solid #34495e; padding-top: 10px;">
				<label style="color: #2ecc71;">Session:</label>
				<div class="control-row">
					<label><input type="checkbox" id="settingAutoSave" checked> Auto-Save Map (LocalStorage)</label>
				</div>
			</div>
			
			<div class="modal-footer">
				<button id="btnCancelSettings" class="secondary">Cancel</button>
				<button id="btnSaveSettings">Save & Apply</button>
			</div>
		</div>
	</div>
	
	<!-- Grid Creation Modal -->
	<div id="gridModal" class="modal-overlay">
		<div class="modal-content">
			<div class="modal-header">Add Object Grid</div>
			
			<div class="control-group">
				<label>Rows:</label>
				<input type="number" id="gridRows" value="3" min="1">
			</div>
			
			<div class="control-group">
				<label>Columns:</label>
				<input type="number" id="gridCols" value="3" min="1">
			</div>
			
			<div class="modal-footer">
				<button id="btnCancelGrid" class="secondary">Cancel</button>
				<button id="btnCreateGrid">Create Grid</button>
			</div>
		</div>
	</div>
	
	<!-- Save Map Modal -->
	<div id="saveMapModal" class="modal-overlay">
		<div class="modal-content">
			<div class="modal-header">Save Map</div>
			
			<div class="control-group">
				<label>Map Name:</label>
				<input type="text" id="saveMapName" value="new_map">
			</div>
			
			<div class="modal-footer">
				<button id="btnCancelSave" class="secondary">Cancel</button>
				<button id="btnConfirmSave">Save</button>
			</div>
		</div>
	</div>
	
	<!-- Custom Context Menu -->
	<div id="context-menu">
		<div class="ctx-item" id="ctx-add-grid">Add Grid of Objects...</div>
	</div>
</div>
</body>
</html>
